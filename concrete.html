<!DOCTYPE html>
<html>

<head>
	<title>Concrete</title>

	<script type="text/javascript">
		module = null;
		page = false;

		function module_loaded() {
			module = document.getElementById("module");
			module.addEventListener("message", handle_message, false);

			if (page)
				init();
		}

		function page_loaded() {
			page = true;

			if (module)
				init();
		}

		function init() {
			var req = new XMLHttpRequest();
			req.open("GET", "code.hex", false);
			req.send();

			if (req.status == 200)
				module.postMessage("run:" + req.responseText);
		}

		function handle_message(event) {
			if (event.data == "done:") {
				handle_done();

			} else if (event.data.substring(0, 6) == "error:") {
				handle_error(event.data.substring(6));

			} else if (event.data.substring(0, 6) == "trace:") {
				handle_trace(event.data.substring(6));

			} else {
				handle_error("Bad message: " + event.data);
			}
		}

		function handle_done() {
			console.log("DONE");
		}

		function handle_error(param) {
			alarm(param);
		}

		function handle_trace(param) {
			console.log("TRACE: " + param);
		}
	</script>
</head>

<body onload="page_loaded()">
	<div id="listener">
		<script type="text/javascript">
			document.getElementById("listener").addEventListener("load", module_loaded, true);
		</script>

		<embed name="nacl_module"
		       id="module"
		       width="0"
		       height="0"
		       src="concrete_dbg.nmf"
		       type="application/x-nacl" />
	</div>
</body>

</html>
